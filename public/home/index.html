<!DOCTYPE html>
<html lang="en" class="no-js">
	<head>
		<title>EJCS:Design Form</title>
		<link rel="stylesheet" type="text/css" href="css/default.css" />
		<link rel="stylesheet" type="text/css" href="css/component.css" />
		<link rel="stylesheet" type="text/css" href="css/load.css" />	
		<style type="text/css">

.img-wrap{
position:relative;
overflow: scroll;
max-height: 500px;
max-width: 500px;
}
</style>
<script src="js/jquery.js"></script>
<script src="http://10.0.0.3:3000/socket.io/socket.io.js"></script>
<script>
var Mdata;
var socket = io.connect('http://10.0.0.3:3000');

socket.emit("ReqOrg",{"data":"trigger"});

socket.on("ResOrg",function(data){
	//console.log(data.Data);
	Mdata = JSON.parse(data.Data);
	console.log(Mdata);
	var i=0;
	for(i=0;i<Mdata.count;i++)
	{
		$("#MNames").append("<input type='checkbox' name='Machine' value='"+i+"'>"+Mdata.Machine[i].name+"</input><br>");
		console.log("Machine Added: "+Mdata.Machine[i].name);
	}
	
	/* $("#MNames").append("<input type='checkbox' name='Abc' value='abc'>ABC</input>"); */
});

/*
socket.on("TransRes",function(data){
	$("#loaderSub").html=data.Data;
});
*/

/*
function cancelTrans()
{
socket.emit("CancelTrans",{"Data":"cancel"});
}
*/

</script>

	</head>
	<body>

		<div class="container">
			<header class="clearfix">
				<h1>Submit Design Files</h1>
				<nav>
					<a href="../postlogin/postlogin.html" class="bp-icon bp-icon-prev" data-info="Go Back"><span>Back</span></a>
				</nav>
			</header>
	

			<div class="main">
				<form id="uploadForm" method="post" action="http://localhost:3000/api/photos/" enctype="multipart/form-data">
					<div class="cbp-mc-column">
						<div class="cbp-mc-form">
	  					<label for="design_file">Uload Design</label>
	  					<input type="file" id="userPhoto" name="userPhoto" accept="image" placeholder=""> 									
	  				</div>
	  				<br><br>
	  				<div class="cbp-mc-column" id="MNames">
<!--
	  				<input type="checkbox" name="Machine" value="1">Machine1<br>
	  				<input type="checkbox" name="Machine" value="2">Machine2<br>
	  				<input type="checkbox" name="Machine" value="1">Machine3<br>
	  				<input type="checkbox" name="Machine" value="2">Machine4<br>
-->
	  				</div>
	  				
	  				<div class="cbp-mc-column" id="MTypes">
	  <!--
				<input type="radio" name="Type" value="1">Type1<br>
	  				<input type="radio" name="Type" value="2">Type2<br>
	  				<input type="radio" name="Type" value="1">Type3<br>
	  				<input type="radio" name="Type" value="2">Type4<br>
-->
	  				</div>
	  				
	  				<!-- <span  id="status" /> -->
	  				<div class="cbp-mc-submit-wrap"><input class="submitClass" type="submit" name="submit" id="submit" value="SUBMIT" />
	  				</div>
				</form>
			</div>

		</div>
		
		<div id="img-wrap" class="img-wrap">
	<canvas id="mcanvas" width="500px" height="500px"></canvas>
	</div>

	<div class="loader" id="loader">
	<div class="loader__item">U</div>
  <div class="loader__item">P</div>
  <div class="loader__item">L</div>
  <div class="loader__item">O</div>
  <div class="loader__item">A</div>
  <div class="loader__item">D</div>
  <div class="loader__item">I</div>
  <div class="loader__item">N</div>
  <div class="loader__item">G</div>
  <div class="loader__item">&nbsp;</div>
  <div class="loader__item">F</div>
  <div class="loader__item">I</div>
  <div class="loader__item">L</div>
  <div class="loader__item">E</div>
  </div>
  <br><br>
  
  <div class ="loaderSub" id="loaderSub">
  <pre>  Trial</pre>
  </div>
  
  <div id="cancel" style="visibility:hidden">
  <button onclick="cancelTrans()">CANCEL</button>
  </div>
  
	</body>
	
	<script>
	
		var canvas = document.getElementById("mcanvas");
	var ctx = canvas.getContext('2d');
	
	if (window.File && window.FileReader && window.FileList && window.Blob) {
	  //do your stuff!
	     document.getElementById('userPhoto').addEventListener('change', readSingleFile, false);
		 
	} else {
	  alert('The File APIs are not fully supported by your browser.');
	}
	
	function readSingleFile(evt) {
	console.log("Event Activated");
	var f = evt.target.files[0];
    if (f) {
      var r = new FileReader();
      r.onload = function(e) { 
	  
		ar=e.target.result;
		buft=new Uint8Array(ar);
		
		//start reading header
		No_of_Legs =7;
		No_Of_Hooks = 672;
		loomtype=buft[0] + buft[1] *  256;
		LC = buft[2] + buft[3] *  256;
		No_of_LoomcontrollerCards=LC; //reassignment
		 
		max_weaveno = buft[4] + (buft[5] * 256);	
		No_of_Weavelines=max_weaveno;//reassignment//reassignment//reassignment
		 
		if (loomtype == 0 || loomtype == 64)
				Size_of_Leg = 64;
		else
			Size_of_Leg = loomtype;
			
			
			//loom configuration calculation
			Size_of_LoomcontrollerCard = No_of_Legs * Size_of_Leg;
			No_Of_CardsPerLeg = Size_of_Leg / 8;
			No_Of_BytesPerCard = No_Of_CardsPerLeg * 7;
			if (No_Of_BytesPerCard <= 64)
                    No_Of_BytesPerCard = 64;
			
		if((No_of_Legs * Size_of_Leg * LC) != No_Of_Hooks)
		{
			console.log(No_of_Legs * Size_of_Leg * LC);
			alert("\nInValid LMKFile....\n");
			return;	
		}
		else
		{
			/* alert("valid lmk file"); */
		}
		var xx=18;
		var data = new Array(No_of_Weavelines*No_of_LoomcontrollerCards);
                for (i = 0; i < (No_of_Weavelines*No_of_LoomcontrollerCards); i++)
                {
                    
                    //data[i] = new byte[64];hcjcjjjgc
				
                    data[i] = new Array(No_Of_BytesPerCard);
                    //fs.Read(data[i], 0, 64);
					for(j=0;j<No_Of_BytesPerCard;j++)
					data[i][j]=buft[xx++];
                    //fs.Read(data[i], 0, No_Of_BytesPerCard);
                }
		
		
		//rendering starts here loom display logic for handlooms
		canvas.width=No_of_LoomcontrollerCards * Size_of_LoomcontrollerCard;
		canvas.height=No_of_Weavelines;
		console.log(canvas.width);
		console.log(canvas.height);
		
		// create a new batch of pixels with the same
		// dimensions as the image:
		var imageData = ctx.createImageData(canvas.width, canvas.height);
		
		var dig_data = new Array(No_of_LoomcontrollerCards * No_Of_BytesPerCard);
		
		for (lines = 0; lines < No_of_Weavelines; lines++)
         {
		 	var v=0;
			for (i = 0; i < No_of_LoomcontrollerCards; i++)
				for (j = 0; j < No_Of_BytesPerCard; j++)
					dig_data[v++] = data[lines * No_of_LoomcontrollerCards + i][j];
				
			v = 0;
			for (LCS = 0; LCS < No_of_LoomcontrollerCards; LCS++)
			{
				for (i = 0; i < 7; i++)
				{
					 mask = 0x01;
					for (l = 0; l < 8; l++)
					{
						for (k = 0; k < No_Of_CardsPerLeg; k++)
						{
							
							if ((dig_data[LCS * No_Of_BytesPerCard + i * No_Of_CardsPerLeg + k] & (1 << l)) != 0)
							{
								setPixel(imageData, v, lines, 255, 255, 255, 255); // 255 opaque
							}
							else
							{
								setPixel(imageData, v, lines, 0, 0, 0, 255)
							}
							v++;
							// b.SetPixel(v++, lines, Color.White);

						}
					}
				}

            }
       }
		//for(i=18;i<av.length;i++)
		//console.log(av[i]);
		
		// copy the image data back onto the canvas
		ctx.putImageData(imageData, 0, 0);	
      }
     // r.readAsText(f);
	 r.readAsArrayBuffer(f);
    //r.readAsBinaryString(f);
	} else { 
      alert("Failed to load file");  
    }
	
  }
  
function setPixel(imageData, x, y, r, g, b, a) {
	index = (x + y * imageData.width) * 4;
	imageData.data[index+0] = r;
	imageData.data[index+1] = g;
	imageData.data[index+2] = b;
	imageData.data[index+3] = a;
}

</script>
<script src="js/modernizr.custom.js"></script>
<script src="js/upload.js"></script>
<script src="js/jquery.form.js"></script>

</html>
